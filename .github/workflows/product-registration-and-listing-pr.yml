name: Product Registration and Listing

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [main]

env:
  MAINNET_SDK_VERSION: "0.6.1"
  BAKERLOO_SDK_VERSION: "0.6.1-dev"

jobs:
  detect-environment:
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.detect.outputs.environment }}
      has_changes: ${{ steps.detect.outputs.has_changes }}
      changed_files: ${{ steps.detect.outputs.changed_files }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect environment from changed files
        id: detect
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            # For PRs, compare against base branch
            CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
          else
            # For push, compare against previous commit
            CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }})
          fi

          echo "Changed files:"
          echo "$CHANGED_FILES"

          # Filter to only JSON files in product-registration-and-listing
          JSON_FILES=$(echo "$CHANGED_FILES" | grep "^product-registration-and-listing/.*/.*\.json$" || true)
          echo "JSON files: $JSON_FILES"
          echo "changed_files<<EOF" >> $GITHUB_OUTPUT
          echo "$JSON_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          BAKERLOO_CHANGES=$(echo "$CHANGED_FILES" | grep -c "^product-registration-and-listing/bakerloo/" || true)
          MAINNET_CHANGES=$(echo "$CHANGED_FILES" | grep -c "^product-registration-and-listing/mainnet/" || true)

          echo "Bakerloo changes: $BAKERLOO_CHANGES"
          echo "Mainnet changes: $MAINNET_CHANGES"

          # Fail if changes span multiple environments
          if [ "$BAKERLOO_CHANGES" -gt 0 ] && [ "$MAINNET_CHANGES" -gt 0 ]; then
            echo "::error::PR contains changes to both bakerloo and mainnet folders. Please submit separate PRs for each environment."
            exit 1
          fi

          # Determine environment
          if [ "$BAKERLOO_CHANGES" -gt 0 ]; then
            echo "environment=Bakerloo" >> $GITHUB_OUTPUT
            echo "has_changes=true" >> $GITHUB_OUTPUT
          elif [ "$MAINNET_CHANGES" -gt 0 ]; then
            echo "environment=Mainnet" >> $GITHUB_OUTPUT
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

  validate:
    needs: detect-environment
    if: needs.detect-environment.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    environment: ${{ needs.detect-environment.outputs.environment }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ "${{ needs.detect-environment.outputs.environment }}" == "Bakerloo" ]; then
            pip install git+https://github.com/autonity/afp-sdk@v${{ env.BAKERLOO_SDK_VERSION }} psycopg2-binary
          else
            pip install afp-sdk==${{ env.MAINNET_SDK_VERSION }} psycopg2-binary
          fi

      - name: Display environment
        run: |
          echo "Running validation for environment: ${{ needs.detect-environment.outputs.environment }}"

      - name: Validate product specifications with SDK
        env:
          AUTONITY_RPC_URL: ${{ vars.AUTONITY_RPC_URL }}
          VALIDATION_PRIVATE_KEY: ${{ secrets.VALIDATION_PRIVATE_KEY }}
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_PORT: ${{ secrets.DB_PORT }}
          DB_NAME: ${{ secrets.DB_NAME }}
          DB_USERNAME: ${{ secrets.DB_USERNAME }}
          DB_PWD: ${{ secrets.DB_PWD }}
        run: |
          echo "Validating product specifications..."

          # Process each changed JSON file
          while IFS= read -r file; do
            if [ -n "$file" ] && [ -f "$file" ]; then
              echo "Validating: $file"
              python scripts/validate.py "$file"
            fi
          done <<< "${{ needs.detect-environment.outputs.changed_files }}"

          echo "All product specifications validated successfully"

  register-and-list:
    needs: [detect-environment, validate]
    if: github.event_name == 'push' && needs.detect-environment.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    environment: ${{ needs.detect-environment.outputs.environment }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ "${{ needs.detect-environment.outputs.environment }}" == "Bakerloo" ]; then
            pip install git+https://github.com/autonity/afp-sdk@v${{ env.BAKERLOO_SDK_VERSION }}
          else
            pip install afp-sdk==${{ env.MAINNET_SDK_VERSION }}
          fi

      - name: Register and list products
        env:
          AUTONITY_RPC_URL: ${{ vars.AUTONITY_RPC_URL }}
          IPFS_API_URL: ${{ vars.IPFS_API_URL }}
          IPFS_API_KEY: ${{ secrets.IPFS_API_KEY }}
          REGISTRATION_PRIVATE_KEY: ${{ secrets.REGISTRATION_PRIVATE_KEY }}
          EXCHANGE_URL: ${{ vars.EXCHANGE_URL }}
          EXCHANGE_ADMIN_KEY: ${{ secrets.EXCHANGE_ADMIN_KEY }}
        run: |
          echo "Registering and listing products for environment: ${{ needs.detect-environment.outputs.environment }}"

          # Process each changed JSON file
          while IFS= read -r file; do
            if [ -n "$file" ] && [ -f "$file" ]; then
              echo "========================================"
              echo "Processing: $file"
              echo "========================================"

              # Step 1: Register product (pins to IPFS + registers on-chain)
              echo "Step 1: Registering product..."
              REGISTER_OUTPUT=$(python scripts/register_product.py "$file")
              echo "$REGISTER_OUTPUT"

              # Extract product ID from output
              PRODUCT_ID=$(echo "$REGISTER_OUTPUT" | grep "^PRODUCT_ID=" | cut -d'=' -f2)
              if [ -z "$PRODUCT_ID" ]; then
                echo "::error::Failed to extract product ID from registration output"
                exit 1
              fi
              echo "Registered product ID: $PRODUCT_ID"

              # Step 2: List product on exchange
              echo "Step 2: Listing product on exchange..."
              python scripts/list_product.py "$PRODUCT_ID"

              echo "Product $PRODUCT_ID registered and listed successfully"

              # Wait for nonce to propagate before processing next product
              echo "Waiting for transaction propagation..."
              sleep 5
            fi
          done <<< "${{ needs.detect-environment.outputs.changed_files }}"

          echo "All products registered and listed successfully"
