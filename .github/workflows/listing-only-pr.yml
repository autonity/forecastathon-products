name: Listing Only

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'listing-only/bakerloo/**'
      - 'listing-only/mainnet/**'
  push:
    branches: [main]
    paths:
      - 'listing-only/bakerloo/**'
      - 'listing-only/mainnet/**'

jobs:
  detect-environment:
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.detect.outputs.environment }}
      has_changes: ${{ steps.detect.outputs.has_changes }}
      changed_files: ${{ steps.detect.outputs.changed_files }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect environment from changed files
        id: detect
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            # For PRs, compare against base branch
            CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
          else
            # For push, compare against previous commit
            CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }})
          fi

          echo "Changed files:"
          echo "$CHANGED_FILES"

          # Filter to only JSON files in listing-only
          JSON_FILES=$(echo "$CHANGED_FILES" | grep "^listing-only/.*/.*\.json$" || true)
          echo "JSON files: $JSON_FILES"
          echo "changed_files<<EOF" >> $GITHUB_OUTPUT
          echo "$JSON_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          BAKERLOO_CHANGES=$(echo "$CHANGED_FILES" | grep -c "^listing-only/bakerloo/" || true)
          MAINNET_CHANGES=$(echo "$CHANGED_FILES" | grep -c "^listing-only/mainnet/" || true)

          echo "Bakerloo changes: $BAKERLOO_CHANGES"
          echo "Mainnet changes: $MAINNET_CHANGES"

          # Fail if changes span multiple environments
          if [ "$BAKERLOO_CHANGES" -gt 0 ] && [ "$MAINNET_CHANGES" -gt 0 ]; then
            echo "::error::PR contains changes to both bakerloo and mainnet folders. Please submit separate PRs for each environment."
            exit 1
          fi

          # Determine environment
          if [ "$BAKERLOO_CHANGES" -gt 0 ]; then
            echo "environment=Bakerloo" >> $GITHUB_OUTPUT
            echo "has_changes=true" >> $GITHUB_OUTPUT
          elif [ "$MAINNET_CHANGES" -gt 0 ]; then
            echo "environment=Mainnet" >> $GITHUB_OUTPUT
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

  validate:
    needs: detect-environment
    if: needs.detect-environment.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    environment: ${{ needs.detect-environment.outputs.environment }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install git+https://github.com/autonity/afp-sdk@v0.6.0-rc.8

      - name: Display environment
        run: |
          echo "Running validation for environment: ${{ needs.detect-environment.outputs.environment }}"

      - name: Validate JSON structure
        run: |
          ENV_FOLDER="${{ needs.detect-environment.outputs.environment == 'Bakerloo' && 'bakerloo' || 'mainnet' }}"

          echo "Validating JSON files in listing-only/$ENV_FOLDER/"

          find "listing-only/$ENV_FOLDER" -name "*.json" -type f | while read -r file; do
            echo "Validating: $file"
            if ! jq empty "$file" 2>/dev/null; then
              echo "::error::Invalid JSON in $file"
              exit 1
            fi

            if ! jq -e '.product_id' "$file" > /dev/null 2>&1; then
              echo "::error::Missing required field 'product_id' in $file"
              exit 1
            fi

            echo "Valid JSON structure: $file"
          done

          echo "All JSON files have valid structure"

      - name: Validate products on-chain
        env:
          AUTONITY_RPC_URL: ${{ vars.AUTONITY_RPC_URL }}
          EXCHANGE_URL: ${{ vars.EXCHANGE_URL }}
          VALIDATION_PRIVATE_KEY: ${{ secrets.VALIDATION_PRIVATE_KEY }}
          IPFS_API_URL: ${{ vars.IPFS_API_URL }}
          IPFS_API_KEY: ${{ secrets.IPFS_API_KEY }}
        run: |
          echo "Validating products exist on-chain..."

          # Process each changed JSON file
          while IFS= read -r file; do
            if [ -n "$file" ] && [ -f "$file" ]; then
              echo "Processing: $file"
              PRODUCT_ID=$(jq -r '.product_id' "$file")
              echo "Product ID: $PRODUCT_ID"
              python scripts/validate_product.py "$PRODUCT_ID"
            fi
          done <<< "${{ needs.detect-environment.outputs.changed_files }}"

          echo "All products validated successfully"

  list-products:
    needs: [detect-environment, validate]
    # List on push to main only (for both Bakerloo and Mainnet)
    if: github.event_name == 'push' && needs.detect-environment.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    environment: ${{ needs.detect-environment.outputs.environment }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install git+https://github.com/autonity/afp-sdk@v0.6.0-rc.8

      - name: List products
        env:
          AUTONITY_RPC_URL: ${{ vars.AUTONITY_RPC_URL }}
          EXCHANGE_URL: ${{ vars.EXCHANGE_URL }}
          EXCHANGE_ADMIN_KEY: ${{ secrets.EXCHANGE_ADMIN_KEY }}
        run: |
          echo "Listing products for environment: ${{ needs.detect-environment.outputs.environment }}"

          # Process each changed JSON file
          while IFS= read -r file; do
            if [ -n "$file" ] && [ -f "$file" ]; then
              echo "Processing: $file"
              PRODUCT_ID=$(jq -r '.product_id' "$file")
              echo "Product ID: $PRODUCT_ID"
              python scripts/list_product.py "$PRODUCT_ID"
            fi
          done <<< "${{ needs.detect-environment.outputs.changed_files }}"

          echo "All products listed successfully"
